name: üöÄ Pipeline | Deploy code on development server

on:
  push:
    branches:
      - development

jobs:
  deploy:
    name: üéâ Deploy Frontend and APIs
    runs-on: ubuntu-latest
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîê Load DEVELOPMENT_SECRETS
        run: |
          echo "${{ secrets.DEVELOPMENT_SECRETS }}" | awk '{print}' ORS='\n' > .env

      - name: üìù Create .env file for React
        working-directory: frontend
        run: |
          echo "VITE_BASE_URL=/dev/gms" >> .env
          echo "VITE_API_URL=https://dev82.bharmalsystems.net/dev/gms/api" >> .env

      - name: üîÑ Run Migrations
        run: |
          curl -X GET "https://dev82.bharmalsystems.net/dev/gms/api/run-migrations" -H "X-DEPLOY-TOKEN: GMS"

      - name: üîß Setup Node.js 20.x
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      - name: üì¶ Install & Build Frontend
        working-directory: frontend
        run: |
          npm install 
          npm run build

      - name: üõ† Export ENV Variables
        run: |
          while IFS='=' read -r key value; do 
            if [[ ! "$key" =~ ^# && -n "$key" ]]; then 
              echo "$key=$value" >> $GITHUB_ENV
            fi 
          done < .env

      - name: üìù Create .htaccess File
        run: |
          cat <<EOF > frontend/dist/.htaccess
          <IfModule mod_rewrite.c>
          RewriteEngine On
          RewriteBase /${{ env.BASE_URL }}/

          # Redirect Trailing Slashes...
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)/$ /$1 [L,R=301]

          # Handle Front Controller...
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^ index.html [L]
          </IfModule>
          EOF

      - name: üöÄ Deploy Frontend & .htaccess
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_HOST }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          local-dir: "frontend/dist/"
          server-dir: "public_html/${{ env.BASE_URL }}/"
          dangerous-clean-slate: false

      - name: üìù Create API .env file
        working-directory: api
        run: |
          cp ../.env .env

      - name: üöÄ Deploy API
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ env.FTP_HOST }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          local-dir: "api/"
          server-dir: "public_html/${{ env.BASE_URL }}/api/"
          exclude: "vendor/"
          dangerous-clean-slate: false
